name: Deploy to Production (Development Version)

on:
  push:
    branches: [ prod ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production

env:
  DEPLOY_PATH: /var/www/html

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Check deployment readiness
        run: |
          echo "ğŸ” Verificando prÃ©-requisitos para deploy..."
          echo "ğŸ“ Configure os secrets necessÃ¡rios em: Settings â†’ Secrets and variables â†’ Actions"
          echo "ğŸ”‘ Secrets necessÃ¡rios: HOST, USERNAME, KEY"
          
          if [ "$MISSING_SECRETS" = "true" ]; then
            echo ""
            echo "âŒ Deploy cancelado - Secrets nÃ£o configurados"
            echo ""
            echo "ğŸ“‹ Para configurar os secrets necessÃ¡rios:"
            echo "1. VÃ¡ para Settings â†’ Secrets and variables â†’ Actions"
            echo "2. Adicione os seguintes secrets:"
            echo "   - HOST: endereÃ§o do servidor (ex: meuservidor.com)"
            echo "   - USERNAME: usuÃ¡rio SSH (ex: ubuntu)"
            echo "   - KEY: chave privada SSH completa"
            echo "   - PORT: porta SSH (opcional, padrÃ£o: 22)"
            exit 1
          fi
          
          echo "âœ… Todos os secrets estÃ£o configurados"
          
      - name: Simulate deployment steps
        run: |
          echo "ğŸš€ Simulando deploy..."
          echo "ğŸ“ DiretÃ³rio de deploy: ${{ env.DEPLOY_PATH }}"
          echo "ğŸ¯ Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo ""
          echo "Etapas que serÃ£o executadas:"
          echo "1. âœ… Conectar via SSH"
          echo "2. âœ… Criar backup"
          echo "3. âœ… Atualizar cÃ³digo (git pull)"
          echo "4. âœ… Instalar dependÃªncias (composer)"
          echo "5. âœ… Limpar cache"
          echo ""
          echo "ğŸ‰ Deploy simulado com sucesso!"
          
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        continue-on-error: true
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            cd ${{ env.DEPLOY_PATH }}
            
            # Verificar o status atual
            echo "=== Status do Git ==="
            git status
            
            # Fazer backup antes do deploy
            echo "=== Criando backup ==="
            cp -r . ../backup_$(date +%Y%m%d_%H%M%S) || true
            
            # Atualizar cÃ³digo
            echo "=== Atualizando cÃ³digo ==="
            git fetch origin prod
            git reset --hard origin/prod
            
            # Verificar se hÃ¡ dependÃªncias para atualizar
            if [ -f "composer.json" ]; then
              echo "=== Atualizando dependÃªncias do Composer ==="
              composer install --no-dev --optimize-autoloader
            fi
            
            # Limpar cache se necessÃ¡rio
            echo "=== Limpando cache ==="
            find . -name "*.cache" -delete || true
            
            echo "=== Deploy concluÃ­do com sucesso ==="